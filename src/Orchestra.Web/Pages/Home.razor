@page "/"
@using Orchestra.Web.Models
@using Orchestra.Web.Services
@using Orchestra.Web.Components
@inject OrchestratorService OrchestratorService
@implements IDisposable

<PageTitle>AI Agent Orchestra</PageTitle>

<div class="dashboard">
    <div class="header">
        <h1>🎼 AI Agent Orchestra</h1>

        @if (_state != null)
        {
            <div class="header-stats">
                <div class="stat-inline">
                    <span class="stat-value">@(_repositories?.Values.Sum(r => r.Agents.Count) ?? _state.Agents.Count)</span>
                    <span class="stat-label">Agents</span>
                    <div class="agent-status-breakdown">
                        <div class="status-item status-working">
                            <span class="status-icon">🟢</span>
                            <span class="status-count">@(_repositories?.Values.Sum(r => r.WorkingCount) ?? _state.Agents.Values.Count(a => a.Status == AgentStatus.Working))</span>
                            <span class="status-label">Working</span>
                        </div>
                        <div class="status-item status-idle">
                            <span class="status-icon">🟡</span>
                            <span class="status-count">@(_repositories?.Values.Sum(r => r.IdleCount) ?? _state.Agents.Values.Count(a => a.Status == AgentStatus.Idle))</span>
                            <span class="status-label">Idle</span>
                        </div>
                        <div class="status-item status-error">
                            <span class="status-icon">🔴</span>
                            <span class="status-count">@(_repositories?.Values.Sum(r => r.ErrorCount) ?? _state.Agents.Values.Count(a => a.Status == AgentStatus.Error))</span>
                            <span class="status-label">Error</span>
                        </div>
                        <div class="status-item status-offline">
                            <span class="status-icon">⚫</span>
                            <span class="status-count">@(_repositories?.Values.Sum(r => r.OfflineCount) ?? _state.Agents.Values.Count(a => a.Status == AgentStatus.Offline))</span>
                            <span class="status-label">Offline</span>
                        </div>
                    </div>
                </div>
                <div class="stat-inline">
                    <span class="stat-value">@(_repositories?.Count ?? 0)</span>
                    <span class="stat-label">Repos</span>
                </div>
                <div class="stat-inline">
                    <span class="stat-value">@(_state?.TaskQueue.Count ?? 0)</span>
                    <span class="stat-label">Tasks</span>
                </div>
            </div>
        }

        <div class="header-controls">
            <div class="status-indicator @(_isConnected ? "connected" : "disconnected")">
                @(_isConnected ? "🟢 Connected" : "🔴 Disconnected")
            </div>
            <div class="header-debug">
                <button class="debug-button" @onclick="OnDataRefreshRequested">
                    🔄 Refresh Data
                </button>
            </div>
        </div>
    </div>

    @if (_state != null)
    {

        <div class="main-layout">
            <!-- Enhanced Sidebar per Design Specifications -->
            <div class="enhanced-sidebar sidebar">
                <!-- Repository Context Section -->
                <div class="sidebar-section repository-context sidebar-compact">
                    <RepositorySelector Repositories="_repositories"
                                       SelectedRepository="_selectedRepository"
                                       OnRepositoryChanged="OnRepositoryChanged"
                                       OnRefreshRequested="OnRefreshRequested"
                                       IsLoading="_isRefreshing" />
                </div>

                <!-- Quick Actions Section -->
                <div class="sidebar-section quick-actions-section sidebar-compact">
                    <QuickActions SelectedRepository="_selectedRepository"
                                 RepositoryPath="@GetSelectedRepositoryPath()"
                                 OnTaskQueued="OnTaskQueued" />
                </div>

                <!-- Agent List Section -->
                <div class="sidebar-section agent-list-section">
                    <AgentSidebar Agents="@GetSelectedRepositoryAgents()"
                                 SelectedAgentId="_selectedAgentId"
                                 OnAgentSelected="OnAgentSelected" />
                </div>
            </div>

            <!-- Enhanced Main Content per Design Specifications -->
            <div class="enhanced-main-content main-content">
                <div class="content-panels">
                    <div class="content-panel history-panel">
                        <AgentHistory SelectedAgentId="@GetSelectedAgentSessionId()" />
                    </div>
                    <div class="content-panel queue-panel">
                        <TaskQueue SelectedRepository="_selectedRepository"
                                  RepositoryPath="@GetSelectedRepositoryPath()" />
                    </div>
                </div>
            </div>
        </div>
    }
    else
    {
        <div class="loading">Loading orchestra state...</div>
    }
</div>

@code {
    private OrchestratorState? _state;
    private Dictionary<string, RepositoryInfo>? _repositories;
    private bool _isConnected = false;
    private bool _isRefreshing = false;
    private Timer? _refreshTimer;
    private string _selectedRepository = "";
    private string _selectedAgentId = "";

    protected override async Task OnInitializedAsync()
    {
        await RefreshData();
        _refreshTimer = new Timer(async _ => await InvokeAsync(RefreshData), null, TimeSpan.Zero, TimeSpan.FromSeconds(5));
    }

    private async Task RefreshData()
    {
        _isRefreshing = true;
        StateHasChanged(); // Update UI to show loading state

        try
        {
            _state = await OrchestratorService.GetStateAsync();
            _repositories = await OrchestratorService.GetRepositoriesAsync();
            _isConnected = _state != null && _repositories != null;

            // Set first repository as selected if none selected
            if (string.IsNullOrEmpty(_selectedRepository) && _repositories?.Count > 0)
            {
                _selectedRepository = _repositories.Keys.First();
            }
        }
        catch
        {
            _isConnected = false;
        }
        finally
        {
            _isRefreshing = false;
            StateHasChanged(); // Update UI to hide loading state
        }
    }

    private async Task OnRepositoryChanged(string repositoryName)
    {
        _selectedRepository = repositoryName;
        _selectedAgentId = ""; // Clear selected agent when repository changes
        StateHasChanged();
    }

    private async Task OnRefreshRequested()
    {
        await RefreshData();
    }

    private async Task OnDataRefreshRequested()
    {
        await RefreshData();
    }

    private async Task OnTaskQueued()
    {
        await RefreshData();
    }

    private async Task OnAgentSelected(string agentId)
    {
        _selectedAgentId = agentId;
        StateHasChanged();
    }

    private List<AgentInfo>? GetSelectedRepositoryAgents()
    {
        if (string.IsNullOrEmpty(_selectedRepository) || _repositories == null)
        {
            return null;
        }

        return _repositories.ContainsKey(_selectedRepository)
            ? _repositories[_selectedRepository].Agents
            : null;
    }

    private string? GetSelectedRepositoryPath()
    {
        if (string.IsNullOrEmpty(_selectedRepository) || _repositories == null)
        {
            return null;
        }

        return _repositories.ContainsKey(_selectedRepository)
            ? _repositories[_selectedRepository].Path
            : null;
    }

    private string? GetSelectedAgentSessionId()
    {
        if (string.IsNullOrEmpty(_selectedAgentId) || _repositories == null)
        {
            return null;
        }

        var agent = _repositories.Values
            .SelectMany(r => r.Agents)
            .FirstOrDefault(a => a.Id == _selectedAgentId);

        return agent?.SessionId;
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
