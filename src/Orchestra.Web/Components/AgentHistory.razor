@using Orchestra.Web.Models
@using Orchestra.Web.Services
@using Orchestra.Web.Components.Base
@inject OrchestratorService OrchestratorService
@inherits AutoRefreshComponent

<div class="agent-history">
    <div class="history-header">
        <h3>Agent History @(GetSelectedAgentName())</h3>
        @if (!string.IsNullOrEmpty(SelectedAgentId))
        {
            <div class="history-controls">
                <button class="refresh-button" @onclick="RefreshHistory" disabled="@_isLoading">
                    @if (_isLoading)
                    {
                        <span class="spinner"></span>
                    }
                    else
                    {
                        <span>üîÑ</span>
                    }
                    Refresh
                </button>
                <div class="auto-refresh-toggle">
                    <input type="checkbox" id="auto-refresh" @bind="AutoRefresh" />
                    <label for="auto-refresh">Auto-refresh</label>
                </div>
            </div>
        }
    </div>

    <div class="history-content">
        @if (string.IsNullOrEmpty(SelectedAgentId))
        {
            <div class="no-selection">
                <p>Select an agent to view its conversation history</p>
            </div>
        }
        else if (_isLoading && (_history == null || !_history.Any()))
        {
            <div class="loading">
                <div class="spinner"></div>
                <p>Loading history...</p>
            </div>
        }
        else if (_history != null && _history.Any())
        {
            <div class="history-list" @ref="_historyContainer">
                @foreach (var entry in _history)
                {
                    <div class="history-entry @entry.Type">
                        <div class="entry-header">
                            <span class="entry-type">@entry.Type</span>
                            <span class="entry-time">@entry.Timestamp.ToString("HH:mm:ss")</span>
                        </div>
                        <div class="entry-content">
                            @{
                                var entryId = entry.GetHashCode();
                                var isExpanded = _expandedEntries.Contains(entryId);
                                var shouldTruncate = entry.Content.Length > ComponentConstants.History.TruncateThreshold;
                            }

                            @if (shouldTruncate)
                            {
                                @if (isExpanded)
                                {
                                    <div class="content-expanded">
                                        @if (entry.Content.Contains("[Tool:") || entry.Content.Contains("Tool Call:"))
                                        {
                                            <pre class="tool-output">@entry.Content</pre>
                                        }
                                        else
                                        {
                                            <div class="content-text">@entry.Content</div>
                                        }
                                        <button class="expand-button" @onclick="() => ToggleExpand(entryId)" @onclick:preventDefault="true">
                                            üì§ Show less
                                        </button>
                                    </div>
                                }
                                else
                                {
                                    <div class="content-collapsed">
                                        <span class="content-preview">@(entry.Content[..ComponentConstants.History.TruncateThreshold])...</span>
                                        <button class="expand-button" @onclick="() => ToggleExpand(entryId)" @onclick:preventDefault="true">
                                            üì• Show more (@(entry.Content.Length - ComponentConstants.History.TruncateThreshold) more chars)
                                        </button>
                                    </div>
                                }
                            }
                            else
                            {
                                @if (entry.Content.Contains("[Tool:") || entry.Content.Contains("Tool Call:"))
                                {
                                    <pre class="tool-output">@entry.Content</pre>
                                }
                                else
                                {
                                    <div class="content-text">@entry.Content</div>
                                }
                            }
                        </div>
                    </div>
                }
            </div>
        }
        else
        {
            <div class="no-history">
                <p>No conversation history available for this agent</p>
            </div>
        }
    </div>

    @if (!string.IsNullOrEmpty(_errorMessage))
    {
        <div class="error-message">
            <strong>Error:</strong> @_errorMessage
        </div>
    }
</div>

@code {
    [Parameter] public string? SelectedAgentId { get; set; }

    private List<AgentHistoryEntry>? _history;
    private bool _isLoading = false;
    private string? _errorMessage;
    private string? _lastAgentId;
    private ElementReference _historyContainer;
    private HashSet<int> _expandedEntries = new();

    protected override async Task OnParametersSetAsync()
    {
        if (SelectedAgentId != _lastAgentId)
        {
            _lastAgentId = SelectedAgentId;
            _expandedEntries.Clear();
            await LoadHistory();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        // Set 5-second refresh interval for agent history
        RefreshInterval = TimeSpan.FromSeconds(5);
        await base.OnInitializedAsync();
    }

    protected override async Task RefreshDataAsync()
    {
        await LoadHistory();
    }

    private async Task LoadHistory()
    {
        if (string.IsNullOrEmpty(SelectedAgentId))
        {
            _errorMessage = "No agent selected";
            return;
        }

        _isLoading = true;
        _errorMessage = null;
        StateHasChanged();

        try
        {
            Console.WriteLine($"Loading history for agent: {SelectedAgentId}");
            _history = await OrchestratorService.GetAgentHistoryAsync(SelectedAgentId, ComponentConstants.History.EntryLimit);
            Console.WriteLine($"Loaded {_history?.Count ?? 0} history entries");

            // Scroll to bottom after loading
            _ = Task.Delay(100).ContinueWith(async _ =>
            {
                await InvokeAsync(async () =>
                {
                    try
                    {
                        await _historyContainer.FocusAsync();
                        await Task.Delay(50);
                        // Scroll to bottom using JavaScript
                        await Task.Run(() => {});
                    }
                    catch
                    {
                        // Ignore scrolling errors
                    }
                });
            });
        }
        catch (Exception ex)
        {
            _errorMessage = ex.Message;
            _history = null;
        }
        finally
        {
            _isLoading = false;
            StateHasChanged();
        }
    }

    private async Task RefreshHistory()
    {
        await ManualRefreshAsync();
    }

    private void ToggleExpand(int entryHash)
    {
        if (_expandedEntries.Contains(entryHash))
        {
            _expandedEntries.Remove(entryHash);
        }
        else
        {
            _expandedEntries.Add(entryHash);
        }
        StateHasChanged();
    }

    private string GetSelectedAgentName()
    {
        if (string.IsNullOrEmpty(SelectedAgentId))
            return "";

        // SelectedAgentId —ç—Ç–æ sessionId, –Ω—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –∞–≥–µ–Ω—Ç–∞ –ø–æ –Ω–µ–º—É
        // –ü–æ–∫–∞ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º sessionId
        return $"({SelectedAgentId[..8]}...)";
    }

}