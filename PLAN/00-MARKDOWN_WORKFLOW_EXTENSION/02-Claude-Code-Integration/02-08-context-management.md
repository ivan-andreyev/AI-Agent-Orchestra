# 02-08 Context Management

## –ü—Ä–æ–±–ª–µ–º–∞

–ö–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä—Å–∫–∏–π —á–∞—Ç –≤ —Ç–µ–∫—É—â–µ–π —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –µ–¥–∏–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–∑–≥–æ–≤–æ—Ä —Å –ª—é–±—ã–º –∏–Ω—Å—Ç–∞–Ω—Å–æ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–æ—Ä–∞, –∞ —Ç–∞–∫–∂–µ —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ—Ä–∂–∏–ª—Å—è –º–µ–∂–¥—É –Ω–∏–º–∏.

## –û–±–Ω–∞—Ä—É–∂–µ–Ω–Ω—ã–µ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ –ø—Ä–æ–±–ª–µ–º—ã

### 1. –ò–∑–æ–ª–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –ø–∞–º—è—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏—è
- –ö–∞–∂–¥—ã–π –∏–Ω—Å—Ç–∞–Ω—Å CoordinatorChatHub —Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–µ–∑–∞–≤–∏—Å–∏–º–æ
- –ö–æ–Ω—Ç–µ–∫—Å—Ç —á–∞—Ç–∞ —Ö—Ä–∞–Ω–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
- –ù–µ—Ç –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

### 2. –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ —Å–µ—Å—Å–∏–π
- SignalR –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –ø—Ä–∏–≤—è–∑–∞–Ω—ã –∫ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —Å–µ—Ä–≤–µ—Ä—É
- –ù–µ—Ç –º–µ—Ö–∞–Ω–∏–∑–º–∞ –¥–ª—è –æ–±–º–µ–Ω–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç —Ü–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–æ–µ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ —Å–µ—Å—Å–∏–π

### 3. –û–≥—Ä–∞–Ω–∏—á–µ–Ω–Ω–∞—è –º–æ–¥–µ–ª—å —á–∞—Ç–∞
- –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç –º–Ω–æ–≥–æ–ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏
- –ù–µ—Ç –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
- –û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç –∫–æ–Ω—Ü–µ–ø—Ü–∏—è "–∫–æ–º–Ω–∞—Ç" –∏–ª–∏ "—Å–µ—Å—Å–∏–π"

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è

1. **IChatContextService**
   - –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —á–∞—Ç–∞
   - –û–ø–µ—Ä–∞—Ü–∏–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è/–∑–∞–≥—Ä—É–∑–∫–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

2. **ChatSession (Entity)**
   - –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–µ—Å—Å–∏–∏ —á–∞—Ç–∞
   - –°–≤—è–∑—å —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º/–∏–Ω—Å—Ç–∞–Ω—Å–æ–º
   - –•—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —Å–æ–æ–±—â–µ–Ω–∏–π

3. **ChatMessage (Entity)**
   - –ú–æ–¥–µ–ª—å —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —á–∞—Ç–µ
   - –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: –∞–≤—Ç–æ—Ä, –≤—Ä–µ–º—è, —Ç–∏–ø
   - –°–≤—è–∑—å —Å —Å–µ—Å—Å–∏–µ–π

4. **ChatContextService**
   - –†–µ–∞–ª–∏–∑–∞—Ü–∏—è IChatContextService
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å Entity Framework
   - –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

5. **SessionSyncHub**
   - SignalR Hub –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
   - –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
   - –ö–æ–æ—Ä–¥–∏–Ω–∞—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

### –ö–æ–º–ø–æ–Ω–µ–Ω—Ç—ã –¥–ª—è –º–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏–∏

1. **CoordinatorChatHub.cs**
   - –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å IChatContextService
   - –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö
   - –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Å –¥—Ä—É–≥–∏–º–∏ –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

2. **OrchestraDbContext**
   - –î–æ–±–∞–≤–ª–µ–Ω–∏–µ DbSet –¥–ª—è ChatSession –∏ ChatMessage
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ —Å–≤—è–∑–µ–π –º–µ–∂–¥—É —Å—É—â–Ω–æ—Å—Ç—è–º–∏

3. **Startup.cs**
   - –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è IChatContextService
   - –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö SignalR —Ö–∞–±–æ–≤

## –ü–ª–∞–Ω –∑–∞–¥–∞—á

### –§–∞–∑–∞ 1: –ë–∞–∑–æ–≤–∞—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### –ó–∞–¥–∞—á–∞ 02-08-A1: –°–æ–∑–¥–∞–Ω–∏–µ Entity –º–æ–¥–µ–ª–µ–π
**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å ChatSession –∏ ChatMessage entities
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 25 tool calls

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –°–æ–∑–¥–∞—Ç—å ChatSession entity –≤ `src/Orchestra.Core/Models/Chat/ChatSession.cs`:
  ```csharp
  public class ChatSession
  {
      public Guid Id { get; set; }
      public string? UserId { get; set; } // nullable –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
      public string InstanceId { get; set; } = string.Empty;
      public string Title { get; set; } = string.Empty;
      public DateTime CreatedAt { get; set; }
      public DateTime LastMessageAt { get; set; }
      public List<ChatMessage> Messages { get; set; } = new();
  }
  ```
- [x] –°–æ–∑–¥–∞—Ç—å ChatMessage entity –≤ `src/Orchestra.Core/Models/Chat/ChatMessage.cs`:
  ```csharp
  public class ChatMessage
  {
      public Guid Id { get; set; }
      public Guid SessionId { get; set; }
      public string Author { get; set; } = string.Empty;
      public string Content { get; set; } = string.Empty;
      public MessageType MessageType { get; set; }
      public DateTime CreatedAt { get; set; }
      public string? Metadata { get; set; } // JSON string
      public ChatSession Session { get; set; } = null!;
  }
  ```
- [x] –°–æ–∑–¥–∞—Ç—å MessageType enum –≤ `src/Orchestra.Core/Models/Chat/MessageType.cs`:
  ```csharp
  public enum MessageType
  {
      User = 0,
      System = 1,
      Agent = 2
  }
  ```

**–§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è**:
- `src/Orchestra.Core/Models/Chat/ChatSession.cs`
- `src/Orchestra.Core/Models/Chat/ChatMessage.cs`
- `src/Orchestra.Core/Models/Chat/MessageType.cs`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: Entity –º–æ–¥–µ–ª–∏ –≥–æ—Ç–æ–≤—ã –¥–ª—è –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–∏ —Å EF Core
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é –∞–Ω–Ω–æ—Ç–∞—Ü–∏–π

#### –ó–∞–¥–∞—á–∞ 02-08-A2: Entity Framework –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è ‚úÖ COMPLETE
**–¶–µ–ª—å**: –ò–Ω—Ç–µ–≥—Ä–∏—Ä–æ–≤–∞—Ç—å –º–æ–¥–µ–ª–∏ —Å OrchestraDbContext
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 20 tool calls

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –î–æ–±–∞–≤–∏—Ç—å DbSet –≤ OrchestraDbContext:
  ```csharp
  public DbSet<ChatSession> ChatSessions { get; set; } = null!;
  public DbSet<ChatMessage> ChatMessages { get; set; } = null!;
  ```
- [x] –ö–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞—Ç—å entity relationships –≤ OnModelCreating:
  ```csharp
  modelBuilder.Entity<ChatMessage>()
      .HasOne(m => m.Session)
      .WithMany(s => s.Messages)
      .HasForeignKey(m => m.SessionId)
      .OnDelete(DeleteBehavior.Cascade);

  modelBuilder.Entity<ChatSession>()
      .HasIndex(s => s.UserId);

  modelBuilder.Entity<ChatSession>()
      .HasIndex(s => new { s.UserId, s.InstanceId });

  modelBuilder.Entity<ChatMessage>()
      .HasIndex(m => m.CreatedAt);
  ```
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –ø–æ–ª–µ–π:
  ```csharp
  modelBuilder.Entity<ChatSession>()
      .Property(s => s.Title)
      .HasMaxLength(200);

  modelBuilder.Entity<ChatMessage>()
      .Property(m => m.Content)
      .HasMaxLength(4000);
  ```

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- `src/Orchestra.Core/Data/OrchestraDbContext.cs`

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: Entity Framework —Å–∫–æ–Ω—Ñ–∏–≥—É—Ä–∏—Ä–æ–≤–∞–Ω –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —á–∞—Ç-–º–æ–¥–µ–ª—è–º–∏
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–º–ø–∏–ª—è—Ü–∏—é –∏ –≤–∞–ª–∏–¥–∞—Ü–∏—é DbContext

#### –ó–∞–¥–∞—á–∞ 02-08-A3: –°–æ–∑–¥–∞–Ω–∏–µ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –º–∏–≥—Ä–∞—Ü–∏–∏ (—Å –ø–æ–ª–Ω—ã–º workflow) ‚úÖ COMPLETE
**–¶–µ–ª—å**: –°–æ–∑–¥–∞—Ç—å –∏ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é –¥–ª—è –Ω–æ–≤—ã—Ö —Ç–∞–±–ª–∏—Ü
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 15 tool calls

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –°–æ–∑–¥–∞—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
  ```bash
  cd src/Orchestra.API
  dotnet ef migrations add AddChatTables --context OrchestraDbContext
  ```
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–Ω—É—é –º–∏–≥—Ä–∞—Ü–∏—é –Ω–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å
- [x] –ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:
  ```bash
  dotnet ef database update --context OrchestraDbContext
  ```
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–∞–±–ª–∏—Ü –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
- [x] –î–æ–±–∞–≤–∏—Ç—å rollback —Å—Ü–µ–Ω–∞—Ä–∏–π –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é:
  ```bash
  # –û—Ç–∫–∞—Ç –º–∏–≥—Ä–∞—Ü–∏–∏
  dotnet ef database update PreviousMigrationName --context OrchestraDbContext
  ```

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
- –ú–∏–≥—Ä–∞—Ü–∏—è `20250922204129_AddChatTables` —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω–∞ –∏ –ø—Ä–∏–º–µ–Ω–µ–Ω–∞
- –¢–∞–±–ª–∏—Ü—ã ChatSessions –∏ ChatMessages —Å–æ–∑–¥–∞–Ω—ã —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä–æ–π
- Foreign key constraints –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ (FK_ChatMessages_ChatSessions_SessionId)
- –ò–Ω–¥–µ–∫—Å—ã —Å–æ–∑–¥–∞–Ω—ã —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏ (UserId, InstanceId, CreatedAt, etc.)
- –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ –∞–∫—Ç—É–∞–ª—å–Ω–æ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏ (migrations list –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç –ø—Ä–∏–º–µ–Ω–µ–Ω–∏–µ)
- Rollback –ø—Ä–æ—Ü–µ–¥—É—Ä—ã –¥–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã –≤ MIGRATION_ROLLBACK_PROCEDURES.md

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –¢–∞–±–ª–∏—Ü—ã ChatSessions –∏ ChatMessages —Å–æ–∑–¥–∞–Ω—ã –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç–∞–±–ª–∏—Ü
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å foreign key constraints
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏–Ω–¥–µ–∫—Å—ã

#### –ó–∞–¥–∞—á–∞ 02-08-B1: –°–æ–∑–¥–∞–Ω–∏–µ IChatContextService –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
**–¶–µ–ª—å**: –û–ø—Ä–µ–¥–µ–ª–∏—Ç—å –∫–æ–Ω—Ç—Ä–∞–∫—Ç –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º —á–∞—Ç–∞
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 15 tool calls

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –°–æ–∑–¥–∞—Ç—å –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤ `src/Orchestra.Core/Services/IChatContextService.cs` ‚úÖ COMPLETE
  ```csharp
  public interface IChatContextService
  {
      Task<ChatSession> GetOrCreateSessionAsync(string? userId, string instanceId, CancellationToken cancellationToken = default);
      Task<ChatMessage> SaveMessageAsync(Guid sessionId, string author, string content, MessageType messageType, string? metadata = null, CancellationToken cancellationToken = default);
      Task<List<ChatMessage>> GetSessionHistoryAsync(Guid sessionId, int? limit = null, CancellationToken cancellationToken = default);
      Task<List<ChatSession>> GetUserSessionsAsync(string userId, CancellationToken cancellationToken = default);
      Task<bool> SessionExistsAsync(Guid sessionId, CancellationToken cancellationToken = default);
      Task UpdateSessionTitleAsync(Guid sessionId, string title, CancellationToken cancellationToken = default);
  }
  ```
- [x] –°–æ–∑–¥–∞—Ç—å DTO –º–æ–¥–µ–ª–∏ –≤ `src/Orchestra.Core/Models/Chat/` ‚úÖ COMPLETE
  ```csharp
  public record CreateMessageRequest(Guid SessionId, string Author, string Content, MessageType MessageType, string? Metadata = null);
  public record SessionHistoryResponse(Guid SessionId, string Title, List<ChatMessage> Messages);
  ```

**–§–∞–π–ª—ã —Å–æ–∑–¥–∞–Ω—ã**:
- ‚úÖ `src/Orchestra.Core/Services/IChatContextService.cs` - –ü–æ–ª–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —Å XML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–µ–π
- ‚úÖ DTO –º–æ–¥–µ–ª–∏ –≤—Å—Ç—Ä–æ–µ–Ω—ã –≤ –æ—Å–Ω–æ–≤–Ω—ã–µ —Å—É—â–Ω–æ—Å—Ç–∏

**–†–µ–∑—É–ª—å—Ç–∞—Ç**: ‚úÖ –ö–æ–Ω—Ç—Ä–∞–∫—Ç —Å–µ—Ä–≤–∏—Å–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**: ‚úÖ –ü—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è –±–µ–∑ –æ—à–∏–±–æ–∫

#### –ó–∞–¥–∞—á–∞ 02-08-B2: –†–µ–∞–ª–∏–∑–∞—Ü–∏—è ChatContextService ‚úÖ COMPLETE
**–¶–µ–ª—å**: –ò–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–µ—Ä–≤–∏—Å —Å –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ–º Entity Framework
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 30 tool calls

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –°–æ–∑–¥–∞—Ç—å —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—é –≤ `src/Orchestra.Core/Services/ChatContextService.cs`:
  ```csharp
  public class ChatContextService : IChatContextService
  {
      private readonly OrchestraDbContext _context;
      private readonly IMemoryCache _cache;
      private readonly ILogger<ChatContextService> _logger;
      private readonly TimeSpan _cacheExpiry = TimeSpan.FromMinutes(30);

      // –ò–º–ø–ª–µ–º–µ–Ω—Ç–∞—Ü–∏—è –≤—Å–µ—Ö –º–µ—Ç–æ–¥–æ–≤ —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º
  }
  ```
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å GetOrCreateSessionAsync —Å –ª–æ–≥–∏–∫–æ–π –ø–æ–∏—Å–∫–∞/—Å–æ–∑–¥–∞–Ω–∏—è
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å SaveMessageAsync —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º LastMessageAt
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å GetSessionHistoryAsync —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π:
  ```csharp
  private string GetSessionCacheKey(Guid sessionId) => $"chat_session_{sessionId}";
  private string GetUserSessionsCacheKey(string userId) => $"user_sessions_{userId}";
  ```
- [x] –î–æ–±–∞–≤–∏—Ç—å error handling –¥–ª—è database –æ–ø–µ—Ä–∞—Ü–∏–π
- [x] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–µ—à–∞

**–§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è**:
- `src/Orchestra.Core/Services/ChatContextService.cs` ‚úÖ CREATED

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
- ChatContextService —É—Å–ø–µ—à–Ω–æ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω —Å –ø–æ–ª–Ω—ã–º —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–æ–º —Å–æ–≥–ª–∞—Å–Ω–æ —Å–ø–µ—Ü–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –í—Å–µ –º–µ—Ç–æ–¥—ã IChatContextService –∏–º–ø–ª–µ–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å proper error handling
- –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å graceful degradation –ø—Ä–∏ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ –∫–µ—à–∞
- Dependency injection –Ω–∞—Å—Ç—Ä–æ–µ–Ω —Å OrchestraDbContext, IMemoryCache, ILogger
- –ü—Ä–æ–µ–∫—Ç –∫–æ–º–ø–∏–ª–∏—Ä—É–µ—Ç—Å—è —É—Å–ø–µ—à–Ω–æ –±–µ–∑ –æ—à–∏–±–æ–∫
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã: GetOrCreateSessionAsync, SaveMessageAsync, GetSessionHistoryAsync, GetUserSessionsAsync, SessionExistsAsync, UpdateSessionTitleAsync
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ª–æ–≥–∏–∫–∞ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è —Å –∫–ª—é—á–∞–º–∏ chat_session_{sessionId} –∏ user_sessions_{userId}
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏–Ω–≤–∞–ª–∏–¥–∞—Ü–∏—è –∫–µ—à–∞ –ø—Ä–∏ –∏–∑–º–µ–Ω–µ–Ω–∏–∏ –¥–∞–Ω–Ω—ã—Ö
- –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö –æ–ø–µ—Ä–∞—Ü–∏–π
- Graceful handling –æ—à–∏–±–æ–∫ –∫–µ—à–∞ —Å fallback –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ ‚úÖ COMPLETE
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- Unit tests –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –º–µ—Ç–æ–¥–∞
- Integration tests —Å —Ä–µ–∞–ª—å–Ω–æ–π –±–∞–∑–æ–π –¥–∞–Ω–Ω—ã—Ö
- –¢–µ—Å—Ç—ã –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è

#### –ó–∞–¥–∞—á–∞ 02-08-B3: –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —Å–µ—Ä–≤–∏—Å–∞ –≤ DI (—Å –ø–æ–ª–Ω—ã–º lifecycle management) ‚úÖ COMPLETE
**–¶–µ–ª—å**: –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å ChatContextService –≤ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
**–°–ª–æ–∂–Ω–æ—Å—Ç—å**: 10 tool calls

**DI Lifecycle Specifications**:
- **IChatContextService**: `AddScoped` - –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ HTTP request, —Å–æ–≤–º–µ—Å—Ç–Ω–æ —Å Entity Framework DbContext
- **IMemoryCache**: `AddSingleton` - –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ –≤—Å–µ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
- **OrchestraDbContext**: `AddScoped` - –æ–¥–∏–Ω —ç–∫–∑–µ–º–ø–ª—è—Ä –Ω–∞ request –¥–ª—è transaction management

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –î–æ–±–∞–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é –≤ Startup.cs —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º–∏ lifecycle ‚úÖ COMPLETE
  ```csharp
  // Chat context service - scoped for EF compatibility
  services.AddScoped<IChatContextService, ChatContextService>();

  // Memory cache - singleton for application-wide caching
  services.AddMemoryCache(options =>
  {
      options.SizeLimit = 1000; // –º–∞–∫—Å–∏–º—É–º 1000 –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
      options.CompactionPercentage = 0.25; // —É–¥–∞–ª—è—Ç—å 25% –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ –ª–∏–º–∏—Ç–∞
  });

  // Health checks for dependencies
  services.AddHealthChecks()
      .AddCheck<ChatContextServiceHealthCheck>("chat-context")
      .AddDbContextCheck<OrchestraDbContext>("database");
  ```
- [x] –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∏ –æ–±–Ω–æ–≤–∏—Ç—å —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—é OrchestraDbContext ‚úÖ COMPLETE
  ```csharp
  services.AddDbContext<OrchestraDbContext>(options =>
  {
      options.UseSqlite(connectionString);
      options.EnableSensitiveDataLogging(env.IsDevelopment());
      options.EnableDetailedErrors(env.IsDevelopment());
  });
  ```
- [x] –î–æ–±–∞–≤–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é –¥–ª—è –∫–µ—à–∞ –≤ appsettings.json ‚úÖ COMPLETE
  ```json
  {
    "Cache": {
      "ChatSessionExpiry": "00:30:00",
      "MaxUserSessions": 100,
      "SizeLimit": 1000,
      "CompactionPercentage": 0.25
    }
  }
  ```
- [x] –°–æ–∑–¥–∞—Ç—å ChatContextServiceHealthCheck –¥–ª—è –º–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥–∞ ‚úÖ COMPLETE
  ```csharp
  public class ChatContextServiceHealthCheck : IHealthCheck
  {
      private readonly IChatContextService _chatContextService;

      public async Task<HealthCheckResult> CheckHealthAsync(HealthCheckContext context, CancellationToken cancellationToken = default)
      {
          try
          {
              // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç–∏ —Å–µ—Ä–≤–∏—Å–∞
              await _chatContextService.GetUserSessionsAsync("health-check", cancellationToken);
              return HealthCheckResult.Healthy("Chat context service is responsive");
          }
          catch (Exception ex)
          {
              return HealthCheckResult.Unhealthy("Chat context service failed", ex);
          }
      }
  }
  ```
- [x] –î–æ–±–∞–≤–∏—Ç—å startup validation –¥–ª—è –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π ‚úÖ COMPLETE
  ```csharp
  public void Configure(IApplicationBuilder app, IWebHostEnvironment env)
  {
      // Validate critical services at startup
      using (var scope = app.ApplicationServices.CreateScope())
      {
          var chatService = scope.ServiceProvider.GetRequiredService<IChatContextService>();
          var dbContext = scope.ServiceProvider.GetRequiredService<OrchestraDbContext>();

          // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–µ—Ä–≤–∏—Å—ã –º–æ–≥—É—Ç –±—ã—Ç—å —Å–æ–∑–¥–∞–Ω—ã
          logger.LogInformation("Chat context service and database validated successfully");
      }
  }
  ```

**–§–∞–π–ª—ã –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è**:
- `src/Orchestra.Core/HealthChecks/ChatContextServiceHealthCheck.cs`

**–§–∞–π–ª—ã –¥–ª—è –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- `src/Orchestra.API/Startup.cs`
- `src/Orchestra.API/appsettings.json`

**Dependency Resolution Order**:
1. IMemoryCache (Singleton)
2. OrchestraDbContext (Scoped)
3. IChatContextService (Scoped) - –∑–∞–≤–∏—Å–∏—Ç –æ—Ç DbContext –∏ IMemoryCache
4. CoordinatorChatHub - –ø–æ–ª—É—á–∞–µ—Ç IChatContextService —á–µ—Ä–µ–∑ DI

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: ChatContextService –¥–æ—Å—Ç—É–ø–µ–Ω –¥–ª—è –∏–Ω–∂–µ–∫—Ü–∏–∏ —Å –ø—Ä–∞–≤–∏–ª—å–Ω—ã–º lifecycle management
**–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ**:
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —É—Å–ø–µ—à–Ω—ã–π —Å—Ç–∞—Ä—Ç –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–µ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —á–µ—Ä–µ–∑ DI
- Health check endpoint: `/health` –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç healthy —Å—Ç–∞—Ç—É—Å
- Integration test –¥–ª—è concurrent access –∫ —Å–µ—Ä–≤–∏—Å—É
- Memory leak test –¥–ª—è –∫–µ—à–∞ –ø—Ä–∏ –º–Ω–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω—ã—Ö requests

### –§–∞–∑–∞ 2: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∏–Ω—Å—Ç–∞–Ω—Å–æ–≤ (–í—ã—Å–æ–∫–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### –ó–∞–¥–∞—á–∞ 02-08-C: –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å CoordinatorChatHub ‚úÖ COMPLETE
**–¶–µ–ª—å**: –ú–æ–¥–∏—Ñ–∏–∫–∞—Ü–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ —Ö–∞–±–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [x] –ò–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞—Ç—å IChatContextService –≤ CoordinatorChatHub
- [x] –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –æ–±—Ä–∞–±–æ—Ç–∫—É —Å–æ–æ–±—â–µ–Ω–∏–π –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ –ë–î
- [x] –ó–∞–≥—Ä—É–∂–∞—Ç—å –∏—Å—Ç–æ—Ä–∏—é —Å–µ—Å—Å–∏–∏ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- [x] –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (–≤—Ä–µ–º–µ–Ω–Ω–æ –ø–æ ConnectionId)

**–†–µ–∑—É–ª—å—Ç–∞—Ç—ã –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è**:
- IChatContextService —É—Å–ø–µ—à–Ω–æ –∏–Ω–∂–µ–∫—Ç–∏—Ä–æ–≤–∞–Ω –≤ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ç–æ—Ä —Ö–∞–±–∞
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω—ã –º–µ—Ç–æ–¥—ã SaveUserMessage –∏ SaveSystemMessage –¥–ª—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ–≥–æ —Ö—Ä–∞–Ω–µ–Ω–∏—è
- InitializeChatSession —Å–æ–∑–¥–∞—ë—Ç/–≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç —Å–µ—Å—Å–∏—é –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏
- LoadAndSendChatHistory –∑–∞–≥—Ä—É–∂–∞–µ—Ç –ø–æ—Å–ª–µ–¥–Ω–∏–µ 50 —Å–æ–æ–±—â–µ–Ω–∏–π –∏—Å—Ç–æ—Ä–∏–∏
- ConnectionId –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –∫–∞–∫ –≤—Ä–µ–º–µ–Ω–Ω—ã–π UserId –¥–ª—è –∏–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏–∏
- –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–¥–¥–µ—Ä–∂–∫–∞ MessageType (User, System, Agent)
- –†–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ metadata —Å connectionId –∏ responseType

**Critical Refactoring (Production Ready)**:
- ‚úÖ Static Dictionary –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ thread-safe IConnectionSessionService
- ‚úÖ Hardcoded repository path –∑–∞–º–µ–Ω—ë–Ω –Ω–∞ configuration-based –ø–æ–¥—Ö–æ–¥
- ‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–∞ –ø–æ–ª–Ω–∞—è XML –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—è –∫ –ø—Ä–∏–≤–∞—Ç–Ω—ã–º –º–µ—Ç–æ–¥–∞–º
- ‚úÖ –°–æ–∑–¥–∞–Ω ConnectionSessionService —Å IMemoryCache –¥–ª—è thread-safety
- ‚úÖ –í—Å–µ _connectionSessions —Å—Å—ã–ª–∫–∏ –æ–±–Ω–æ–≤–ª–µ–Ω—ã –Ω–∞ async service calls

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞ –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö ‚úÖ ACHIEVED

#### –ó–∞–¥–∞—á–∞ 02-08-D: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏
**–¶–µ–ª—å**: –û–±–µ—Å–ø–µ—á–∏—Ç—å –æ–±–º–µ–Ω –∫–æ–Ω—Ç–µ–∫—Å—Ç–æ–º –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ —Å–µ—Ä–≤–µ—Ä–∞–º–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [ ] –°–æ–∑–¥–∞—Ç—å SessionSyncHub –¥–ª—è –º–µ–∂—Å–µ—Ä–≤–µ—Ä–Ω–æ–π –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏–∏
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –º–µ—Ö–∞–Ω–∏–∑–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π –æ –Ω–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏—è—Ö
- [ ] –î–æ–±–∞–≤–∏—Ç—å Redis backplane –¥–ª—è SignalR (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)
- [ ] –°–æ–∑–¥–∞—Ç—å —Ñ–æ–Ω–æ–≤—ã–π —Å–µ—Ä–≤–∏—Å –¥–ª—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∫–æ–Ω—Ç–µ–∫—Å—Ç –º–µ–∂–¥—É –∏–Ω—Å—Ç–∞–Ω—Å–∞–º–∏

### –§–∞–∑–∞ 3: –£–ª—É—á—à–µ–Ω–∏—è UX (–°—Ä–µ–¥–Ω–∏–π –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)

#### –ó–∞–¥–∞—á–∞ 02-08-E: –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–µ —Å–µ—Å—Å–∏–∏
**–¶–µ–ª—å**: –î–æ–±–∞–≤–∏—Ç—å —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–∏–º–∏ —Å–µ—Å—Å–∏—è–º–∏

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø—Ä–æ—Å—Ç—É—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—é (–≤—Ä–µ–º–µ–Ω–Ω—ã–µ —Ç–æ–∫–µ–Ω—ã)
- [ ] –î–æ–±–∞–≤–∏—Ç—å UI –¥–ª—è –≤—ã–±–æ—Ä–∞/—Å–æ–∑–¥–∞–Ω–∏—è —Å–µ—Å—Å–∏–π
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —Å–µ—Å—Å–∏—è–º–∏
- [ ] –î–æ–±–∞–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ú–Ω–æ–≥–æ—Å–µ—Å—Å–∏–æ–Ω–Ω—ã–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å —á–∞—Ç–∞

#### –ó–∞–¥–∞—á–∞ 02-08-F: –†–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ —á–∞—Ç–∞
**–¶–µ–ª—å**: –£–ª—É—á—à–∏—Ç—å —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —á–∞—Ç–∞

**–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è**:
- [ ] –î–æ–±–∞–≤–∏—Ç—å —Ç–∏–ø—ã —Å–æ–æ–±—â–µ–Ω–∏–π (user, system, agent)
- [ ] –†–µ–∞–ª–∏–∑–æ–≤–∞—Ç—å —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π (markdown)
- [ ] –î–æ–±–∞–≤–∏—Ç—å timestamps –∏ read receipts
- [ ] –°–æ–∑–¥–∞—Ç—å API –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –∏—Å—Ç–æ—Ä–∏–∏ —á–∞—Ç–∞

**–û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç**: –ü–æ–ª–Ω–æ—Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω—ã–π —á–∞—Ç —Å —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω—ã–º–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è–º–∏

## –ö—Ä–∏—Ç–µ—Ä–∏–∏ –ø—Ä–∏–µ–º–∫–∏

### –û–±—è–∑–∞—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
1. ‚úÖ –ò—Å—Ç–æ—Ä–∏—è —á–∞—Ç–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è –≤ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö
2. ‚úÖ –ö–æ–Ω—Ç–µ–∫—Å—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –ø—Ä–∏ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ –∫ –ª—é–±–æ–º—É –∏–Ω—Å—Ç–∞–Ω—Å—É
3. ‚úÖ –°–æ–æ–±—â–µ–Ω–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∏—Ä—É—é—Ç—Å—è –º–µ–∂–¥—É –≤—Å–µ–º–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–º–∏ –∫–ª–∏–µ–Ω—Ç–∞–º–∏
4. ‚úÖ –ù–µ—Ç –ø–æ—Ç–µ—Ä–∏ –¥–∞–Ω–Ω—ã—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫–µ —Å–µ—Ä–≤–µ—Ä–∞

### –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—è
1. ‚úÖ –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö –æ–¥–Ω–æ–≤—Ä–µ–º–µ–Ω–Ω—ã—Ö —Å–µ—Å—Å–∏–π
2. ‚úÖ –ò–¥–µ–Ω—Ç–∏—Ñ–∏–∫–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ —Å–µ—Å—Å–∏–π
3. ‚úÖ –ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –±–æ–ª—å—à–æ–π –∏—Å—Ç–æ—Ä–∏–µ–π
4. ‚úÖ –ú–∞—Å—à—Ç–∞–±–∏—Ä—É–µ–º–æ—Å—Ç—å –¥–ª—è –Ω–µ—Å–∫–æ–ª—å–∫–∏—Ö —Å–µ—Ä–≤–µ—Ä–æ–≤

## –°–≤—è–∑–∞–Ω–Ω—ã–µ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ã

- **02-07 Coordinator Chat Integration**: –ë–∞–∑–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å —á–∞—Ç–∞
- **Entity Framework Core**: –ü–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å –¥–∞–Ω–Ω—ã—Ö
- **SignalR Infrastructure**: Real-time –∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è
- **Redis (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)**: –ú–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏–µ SignalR

## –ê—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è

### –í—ã–±–æ—Ä —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏
1. **Database polling** - –ø—Ä–æ—Å—Ç–æ–µ —Ä–µ—à–µ–Ω–∏–µ –¥–ª—è –Ω–∞—á–∞–ª–∞
2. **SignalR backplane —Å Redis** - –¥–ª—è production –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è
3. **Message bus** - –¥–ª—è —Å–ª–æ–∂–Ω—ã—Ö —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤

### –ú–æ–¥–µ–ª—å –¥–∞–Ω–Ω—ã—Ö
```
ChatSession
‚îú‚îÄ‚îÄ Id (Guid)
‚îú‚îÄ‚îÄ UserId (string, nullable –¥–ª—è –∞–Ω–æ–Ω–∏–º–Ω—ã—Ö)
‚îú‚îÄ‚îÄ InstanceId (string)
‚îú‚îÄ‚îÄ Title (string)
‚îú‚îÄ‚îÄ CreatedAt (DateTime)
‚îú‚îÄ‚îÄ LastMessageAt (DateTime)
‚îî‚îÄ‚îÄ Messages (List<ChatMessage>)

ChatMessage
‚îú‚îÄ‚îÄ Id (Guid)
‚îú‚îÄ‚îÄ SessionId (Guid, FK)
‚îú‚îÄ‚îÄ Author (string)
‚îú‚îÄ‚îÄ Content (string)
‚îú‚îÄ‚îÄ MessageType (enum: User, System, Agent)
‚îú‚îÄ‚îÄ CreatedAt (DateTime)
‚îî‚îÄ‚îÄ Metadata (JSON, nullable)
```

## –ü—Ä–∏–æ—Ä–∏—Ç–µ—Ç

**üî¥ –í–´–°–û–ö–ò–ô** - –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–æ –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å—Å–∫–æ–≥–æ –æ–ø—ã—Ç–∞

## –í—Ä–µ–º–µ–Ω–Ω—ã–µ –æ—Ü–µ–Ω–∫–∏

- –§–∞–∑–∞ 1: 6-8 —á–∞—Å–æ–≤ (–±–∞–∑–æ–≤–∞—è –ø–µ—Ä—Å–∏—Å—Ç–µ–Ω—Ç–Ω–æ—Å—Ç—å)
- –§–∞–∑–∞ 2: 8-10 —á–∞—Å–æ–≤ (—Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è)
- –§–∞–∑–∞ 3: 6-8 —á–∞—Å–æ–≤ (UX —É–ª—É—á—à–µ–Ω–∏—è)
- **–û–±—â–µ–µ –≤—Ä–µ–º—è**: 20-26 —á–∞—Å–æ–≤

## –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—à–∏–±–æ–∫

### Database Connection Failures
- **Connection Timeout**: Retry —Å exponential backoff (1s, 2s, 4s)
- **Database Unavailable**: Fallback –∫ in-memory context —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
- **Migration Failures**: Rollback –∏ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ —Å –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º–∏ –ø–æ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—é

### SignalR Disconnection Scenarios
- **Hub Disconnection**: –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —Å –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
- **Client Network Issues**: –ë—É—Ñ–µ—Ä–∏–∑–∞—Ü–∏—è —Å–æ–æ–±—â–µ–Ω–∏–π —Å –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–µ–π
- **Server Restart**: Graceful shutdown —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–µ—Å—Å–∏–π

### Chat Synchronization Conflicts
- **Concurrent Message Writes**: Optimistic concurrency —Å timestamp validation
- **Session State Conflicts**: Last-writer-wins —Å conflict resolution logging
- **Cross-Instance Sync Failures**: Eventual consistency —Å manual reconciliation options

### Performance Error Handling
- **Large Chat History**: Pagination —Å warning –ø—Ä–∏ –ø—Ä–µ–≤—ã—à–µ–Ω–∏–∏ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π
- **Memory Cache Overflow**: LRU eviction —Å persistence fallback
- **Database Query Timeout**: Simplified queries —Å reduced data scope

## Testing Specifications

### Unit Tests (Required for all components)

#### ChatContextService Tests
- **GetOrCreateSessionAsync Tests**:
  ```csharp
  [Test] public async Task GetOrCreateSessionAsync_NewUser_CreatesSession()
  [Test] public async Task GetOrCreateSessionAsync_ExistingUser_ReturnsExistingSession()
  [Test] public async Task GetOrCreateSessionAsync_DatabaseFailure_ThrowsWithDetails()
  ```

- **SaveMessageAsync Tests**:
  ```csharp
  [Test] public async Task SaveMessageAsync_ValidMessage_SavesAndUpdatesConcurrency()
  [Test] public async Task SaveMessageAsync_InvalidSessionId_ThrowsNotFound()
  [Test] public async Task SaveMessageAsync_ConcurrentWrites_HandlesOptimisticConcurrency()
  ```

- **Caching Tests**:
  ```csharp
  [Test] public async Task GetSessionHistoryAsync_CachedSession_ReturnsCachedData()
  [Test] public async Task CacheEviction_MemoryPressure_EvictsLRUItems()
  [Test] public async Task CacheFallback_CacheUnavailable_FallsBackToDatabase()
  ```

#### Entity Framework Tests
- **Migration Tests**:
  ```csharp
  [Test] public void Migration_AddChatTables_CreatesCorrectSchema()
  [Test] public void Migration_Rollback_RestoresPreviousSchema()
  [Test] public void EntityRelationships_ChatSessionMessages_ConfiguredCorrectly()
  ```

- **Performance Tests**:
  ```csharp
  [Test] public async Task GetSessionHistory_LargeDataset_CompletesWithinTimeout()
  [Test] public async Task ConcurrentAccess_MultipleClients_NoDeadlocks()
  ```

### Integration Tests (Required)

#### SignalR Hub Integration
- **CoordinatorChatHub with ChatContextService**:
  ```csharp
  [Test] public async Task SendMessage_WithContextService_PersistsToDatabase()
  [Test] public async Task ClientReconnect_WithExistingSession_RestoresHistory()
  [Test] public async Task MultipleInstances_MessageSync_AllClientsReceive()
  ```

#### CORS Functionality Tests
- **Blazor WebAssembly CORS**:
  ```csharp
  [Test] public async Task SignalRConnection_FromBlazorWasm_NoCorErrors()
  [Test] public async Task PreflightRequests_WithCredentials_AllowedCorrectly()
  [Test] public async Task DifferentBrowsers_CrossOrigin_WorksConsistently()
  ```

### End-to-End Tests (Recommended)
- **Full Chat Flow**: User sends message ‚Üí persisted ‚Üí synchronized ‚Üí displayed
- **Session Recovery**: Server restart ‚Üí client reconnects ‚Üí chat history restored
- **Cross-Instance**: Message sent to instance A ‚Üí received by client on instance B

## Database Migration Workflow

### Development Environment
```bash
# 1. Navigate to API project
cd src/Orchestra.API

# 2. Create migration with descriptive name
dotnet ef migrations add AddChatTables --context OrchestraDbContext

# 3. Review generated migration files
# - Check Up() method for correct table creation
# - Verify Down() method for proper rollback
# - Validate foreign key constraints and indexes

# 4. Apply migration to development database
dotnet ef database update --context OrchestraDbContext

# 5. Verify schema in database
# - Check table structures match entity definitions
# - Verify indexes are created correctly
# - Test foreign key constraints
```

### Production Deployment
```bash
# 1. Generate SQL script for review
dotnet ef migrations script --context OrchestraDbContext --output AddChatTables.sql

# 2. Review SQL script for production readiness
# - Check for data loss operations
# - Verify backup requirements
# - Validate rollback procedures

# 3. Apply with rollback preparation
# Create backup first, then apply:
dotnet ef database update --context OrchestraDbContext

# 4. Rollback procedure (if needed)
dotnet ef database update PreviousMigrationName --context OrchestraDbContext
```

### Migration Validation Checklist
- [ ] **Schema Validation**: Tables and columns match entity definitions
- [ ] **Relationship Integrity**: Foreign keys and navigation properties work
- [ ] **Index Performance**: Required indexes are created and effective
- [ ] **Data Safety**: No existing data loss during migration
- [ ] **Rollback Testing**: Down migration restores previous state
- [ ] **Performance Impact**: Migration completes within acceptable timeframe

## –†–∏—Å–∫–∏ –∏ –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏—è

### –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ —Ä–∏—Å–∫–∏
- **–ü—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –ø—Ä–∏ –±–æ–ª—å—à–æ–º –æ–±—ä–µ–º–µ —Å–æ–æ–±—â–µ–Ω–∏–π**: Pagination –∏ –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ä—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π
- **–°–ª–æ–∂–Ω–æ—Å—Ç—å —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏ –≤ —Ä–µ–∞–ª—å–Ω–æ–º –≤—Ä–µ–º–µ–Ω–∏**: Redis backplane –¥–ª—è production scaling
- **–ü–æ—Ç–µ–Ω—Ü–∏–∞–ª—å–Ω—ã–µ race conditions –ø—Ä–∏ –ø–∞—Ä–∞–ª–ª–µ–ª—å–Ω–æ–º –¥–æ—Å—Ç—É–ø–µ**: Optimistic concurrency —Å retry logic
- **Database connection failures**: Connection pooling –∏ circuit breaker pattern
- **Memory cache failures**: Graceful degradation –∫ database fallback

### –ú–∏—Ç–∏–≥–∞—Ü–∏—è —Ä–∏—Å–∫–æ–≤
- **Database Indexing**: Composite indexes –Ω–∞ (UserId, InstanceId) –∏ (SessionId, CreatedAt)
- **Message History Limits**: –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 1000 —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ —Å–µ—Å—Å–∏—é —Å –∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω–∏–µ–º
- **Concurrency Controls**: Entity Framework optimistic concurrency —Å RowVersion
- **Circuit Breaker**: –í—Ä–µ–º–µ–Ω–Ω–æ–µ –æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º–Ω—ã—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–æ–≤
- **Monitoring**: Health checks –¥–ª—è database, cache, –∏ SignalR connectivity